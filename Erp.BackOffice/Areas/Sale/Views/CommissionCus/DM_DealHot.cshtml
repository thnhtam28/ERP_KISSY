@using Erp.BackOffice.App_GlobalResources
@using Erp.BackOffice.Helpers
@using Erp.BackOffice.Sale.Models
@using Erp.Domain.Sale.Entities
@using Erp.BackOffice.Staff.Models

@using GridMvc.Html

@model DM_DEALHOTViewModel

@{
    ViewBag.Title = "Danh mục Deal Hot";
    bool isPopup = Request["IsPopup"] != null && Request["IsPopup"].ToString().ToLower() == "true" ? true : false;
    if (isPopup)
    {
        Layout = "~/Views/Shared/_PopupLayout.cshtml";
    }
    else
    {
        Layout = "~/Views/Shared/ACE_AdminLayout.cshtml";
    }
    var jsCallback = Request["jsCallback"] == null ? "" : Request["jsCallback"].ToString();
    Erp.BackOffice.Models.PageSetting pageSetting = new Erp.BackOffice.Models.PageSetting
    {
        ModuleName = "CommissionCus",
        ActionName = "DM_DealHot",
        PageTitle = ViewBag.Title,
        DisplaySearchPanel = false,
        IsPopup = false,
        DisplayBackButton = false
    };
    List<DM_DEALHOTViewModel> dm_dealhot = (List<DM_DEALHOTViewModel>)ViewBag.DM_DEALHOT;
    IEnumerable<CommissionCusViewModel> commissioncus = (IEnumerable<CommissionCusViewModel>)ViewBag.CommissionCus;
    var list = commissioncus.ToList().Find(x => x.Id == 1009);
    ViewData["CommissionCus_Id"] = "";
    var orderNO = 0;
}

<link href="@Url.Content("~/assets/css/Gridmvc.css")" rel="stylesheet" type="text/css" />
<script src="@Url.Content("~/Scripts/gridmvc.min.js")" type="text/javascript">
/**/

/**/</script>

<style type="text/css">
    .input-edit-inline {
        height: 23px;
        line-height: 23px;
        font-size: 10px;
    }

    .subItem2 {
        border: 1px solid #ddd;
        margin-left: -8px;
        margin-right: -8px;
        padding: 8px;
        border-width: 1px 0px 0px 0px;
        height: 39px;
    }

    .subItem {
        height: 22px;
    }

    .createupdateheader {
        font-size: large;
        font-weight: bold;
    }
</style>
@using (Html.BeginPageHeaderContainer(pageSetting))
{
    <input type="hidden" value="@Request["IsPopup"]" name="IsPopup" />
    <input type="hidden" value="@Request["jsCallback"]" name="jsCallback" />
}

@if (ViewBag.SuccessMessage != null && ViewBag.SuccessMessage != "")
{
    <div class="alert alert-block alert-success">
        <button class="close" data-dismiss="alert" type="button">
            <i class="icon-remove"></i>
        </button>
        <i class="ace-icon fa fa-check green"></i>
        @ViewBag.SuccessMessage
    </div>
}

@if (ViewBag.FailedMessage != null && ViewBag.FailedMessage != "")
{
    <div class="alert alert-block alert-danger">
        <button class="close" data-dismiss="alert" type="button">
            <i class="ace-icon fa fa-times"></i>
        </button>
        <i class="ace-icon fa fa-warning red"></i>
        @ViewBag.FailedMessage
    </div>
}

@if (ViewBag.AlertMessage != null && ViewBag.AlertMessage != "")
{
    <div class="alert alert-block alert-success">
        <button class="close" data-dismiss="alert" type="button">
            <i class="icon-remove"></i>
        </button>
        <i class="ace-icon fa fa-check green"></i>
        @ViewBag.AlertMessage
    </div>
}

@helper GridColumnCommand(int id)
{
    <div class="hidden-phone visible-desktop action-buttons">
        @using (Html.BeginForm("DeleteDealHot", "CommissionCus", FormMethod.Post))
        {
            if (Erp.BackOffice.Filters.SecurityFilter.AccessRight("DeleteDealHot", "CommissionCus", "Sale"))
            {
                <input type="hidden" value="@id" name="Id" />
                <button type="submit" class="btn btn-minier btn-danger" onclick="return confirm('Bạn có muốn xóa dữ liệu không ?');" style="margin-top:-3px">
                    <i class="ace-icon fa fa-trash"></i>
                    Xóa
                </button>
            }
        }
    </div>
}

@helper RenderEditItem(int id, int CommissionCus_Id, string ten, string banner, int? is_show)
{
    var bannersrc = Erp.BackOffice.Helpers.Common.KiemTraTonTaiHinhAnh(banner, "dealhot-image-folder", "dealhot");
    //if (!string.IsNullOrEmpty(banner))
    //{
    //    bannersrc = "~" + bannersrc;
    //}

    <a id="edit" class="btn btn-info btn-minier" onclick="return edit(@id,@CommissionCus_Id,'@ten','@bannersrc','@banner',@is_show)" style="margin-top:-3px">
        <i class="ace-icon fa fa-edit"></i>
        Sửa
    </a>
}

@helper isshow(int id, int is_show)
{
    <label>
        <input id="is_show_table" class="ace table-is-show text-center" type="checkbox" name="is-show-table" value="@is_show" checked="@(is_show == 1? "checked":null)">
        <span class="lbl"></span>
    </label>
}

@helper ShowImage(int id, string banner)
{
    var bannersrc = Erp.BackOffice.Helpers.Common.KiemTraTonTaiHinhAnh(banner, "dealhot-image-folder", "dealhot");
    //if (!string.IsNullOrEmpty(banner))
    //{
    //    bannersrc = "~" + bannersrc;
    //}
    <div class="text-center ace-thumbnails">
        <a id="showimage_@id" name="showimage" href="@bannersrc" data-rel="colorbox" class="cboxElement">
            <span class="glyphicon glyphicon-picture"></span>Xem
        </a>
    </div>

}
<hr>
@using (Html.BeginForm("CreateDealHot", "CommissionCus", FormMethod.Post, new { enctype = "multipart/form-data" }))
{
    @Html.ValidationSummary(true)

    @Html.HiddenFor(model => model.CreatedUserId)
    @Html.HiddenFor(model => model.CreatedDate)
    @Html.HiddenFor(model => model.IsDeleted)
    @Html.HiddenFor(model => model.BANNER)
    @Html.HiddenFor(model => model.CommissionCus_Id)
    @Html.HiddenFor(model => model.CommissionCus_Name)
    @Html.HiddenFor(model => model.DEALHOT_ID)

    <p id="createupdateheader" class="createupdateheader text-center"><span>Tạo Deal Hot</span></p>

    <div class="row">
        <div class="col-sm-12">
            <div class="widget-container-col ui-sortable" id="widget-container-col-10" style="min-height: 108px;">
                <div class="widget-box ui-sortable-handle" id="widget-box-10" style="opacity: 1;">
                    <div class="widget-header widget-header-small">
                        <div class="widget-toolbar no-border pull-left">
                            <ul class="nav nav-tabs" id="myTab">
                                <li class="active">
                                    <a data-toggle="tab" href="#home" aria-expanded="true"><i class="fa fa-info-circle"></i> Tổng quan</a>
                                </li>
                                <li class="">
                                    <a data-toggle="tab" href="#image" aria-expanded="false"><i class="fa fa-image"></i> Ảnh minh họa</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="widget-body" style="overflow: hidden;">
                        <div class="widget-body">
                            <div class="widget-main padding-6">
                                <div class="tab-content">
                                    <div id="home" class="tab-pane active">
                                        <p align="center">
                                            @*<input id="CommissionCus_Id" name="CommissionCus_Id" type="text" hidden />*@
                                            <select id="CommissionCusSelectList" name="CommissionCusSelectList" style="width:250px">
                                                <option value="">- Tìm chương trình khuyến mãi -</option>
                                                @foreach (var item in commissioncus)
                                                {
                                                    <option value="@item.Id" data-selected="0" data-name="@item.Name">@item.Name</option>
                                                }
                                            </select>

                                            <span>Hiện</span>
                                            <label>
                                                <input id="is_show" class="ace class-is-show" type="checkbox" name="is-show-checkbox" value="1" checked="checked">
                                                <span class="lbl"></span>
                                            </label>

                                        </p>

                                    </div>
                                    <div id="image" class="tab-pane">
                                        <div class="wrap-btn-upload">
                                            <a class="btn btn-primary btn-sm btn-white"><i class="fa fa-upload"></i><span>Tải hình mới</span></a>
                                            <input type="file" id="file-image" name="file-image" class="file-image" onchange="previewFileImage(event, '#display-image img')" />
                                        </div>
                                        <div class="text-center" id="display-image">
                                            <img src="/assets/css/images/noimage.gif" title="@Model.CommissionCus_Name" id="" style="max-height:250px" />
                                        </div>
                                    </div>
                                </div>
                                <div style="float:left;padding-left:50%;">
                                    <a class="btn btn-mini btn-black" onclick="return reset()">
                                        Nhập lại
                                        <i class="ace-icon fa fa-refresh icon-on-right"></i>
                                    </a>
                                </div>

                                <div style="float:right;">
                                    @if (Erp.BackOffice.Filters.SecurityFilter.AccessRight("CreateDealHot", "CommissionCus", "Sale"))
                                    {
                                        <button id="save" name="Save" value="Save" type="submit" class="btn btn-mini btn-primary" href="@Url.Action("CreateDealHot", pageSetting.ModuleName)">
                                            <i class="ace-icon fa fa-plus"></i>
                                            @Wording.Save
                                        </button>
                                    }
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}
<hr>
<div class="col-sm-5 ">
    <table id="CTable" class="table table-striped table-bordered table-hover">
        <thead>
            <tr>
                <th width="10px">#</th>
                <th style="width:250px">Tên chương trình khuyến mãi</th>
                <th style="width:10px">Xem Ảnh</th>
                <th style="width:10px">Hiện Ảnh</th>
                <th style="width:10px">Chỉnh sửa</th>
                <th style="width:10px">xóa</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in dm_dealhot)
            {
                orderNO++;
                <tr>
                    <td>@orderNO</td>
                    <td>@item.CommissionCus_Name</td>
                    <td>@ShowImage(item.DEALHOT_ID, item.BANNER)</td>
                    <td>@isshow(item.DEALHOT_ID, item.IS_SHOW)</td>
                    <td>
                        @RenderEditItem(item.DEALHOT_ID, item.CommissionCus_Id, item.CommissionCus_Name, item.BANNER, item.IS_SHOW)
                    </td>
                    <td>
                        @GridColumnCommand(item.DEALHOT_ID)
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>
<script>

    $('#test').find('table.table.table-striped.grid-table').first().attr('id', 'CTable');


</script>

<script src="~/Scripts/jquery.freezeheader.js"></script>
<script>
    $(document).ready(function () {
        $("#CTable").freezeHeader({ 'offset': '30px' });
    })
</script>
<div id="commissioncusdetail" class="col-sm-7 ">
</div>
@*@Html.Partial("_DealHot_CommissionCusDetail", list)*@

@section Scripts {
    <script type="text/javascript">
        $(document).ready(function () {

        $(function () {

            $('#CommissionCusSelectList').on('change', function () {
                var $this = $(this);
                var selected = $this.find("option:selected");

                if (selected.val() == '')
                    return;
                $("#CommissionCus_Id").val(selected.val());
                $("#CommissionCus_Name").val(selected.text());

                loadPartailDetail(selected.val());
            });

            $("#save").click(function () {
                if ($('#BANNER').val() == null) {
                    if ($('#file-image').get(0).files.length === 0) {
                        alert("Chưa chọn banner");
                        return false;
                    }
                }
            });
        });
        });

        function loadPartailDetail(CommissionCus_Id)
        {
            var url = '@Url.Action("_DealHot_CommissionCusDetail", "CommissionCus")';
            url += '/?Id=' + CommissionCus_Id;
            $("#commissioncusdetail").load(url);
        }

        function edit(id, CommissionCus_Id, ten, bannersrc, banner, is_show) {
                $("#DEALHOT_ID").val(id);
                $("#CommissionCus_Id").val(CommissionCus_Id);
                $("#CommissionCus_Name").val(ten);
                $("#BANNER").val(banner);
                $('#CommissionCusSelectList').val(CommissionCus_Id);
                $("#display-image img").attr("src", bannersrc);
                $("#createupdateheader").text("sửa Deal Hot-" + ten);
                if (is_show == 1) {
                    $("#is_show").prop('checked', true);
                }
                else {
                    $("#is_show").prop('checked', false);
                }

                loadPartailDetail(CommissionCus_Id);

            }

        function reset() {
                $("#DEALHOT_ID").val(0);
                $("#CommissionCus_Id").val(0);
                $("#CommissionCus_Name").val("");
                $('#CommissionCusSelectList').val("");
                $("#display-image img").attr("src", "/assets/css/images/noimage.gif");
                $("#createupdateheader").text("Tạo Deal Hot");
                $("#is_show").prop('checked', true);

            }
    </script>
}
